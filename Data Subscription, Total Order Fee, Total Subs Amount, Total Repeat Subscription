# MENCARI DATA MERCHANT, PLAN, SUBS START/END

SELECT distinct
    sb."name" AS merchant,
    p."name" AS plan,
    TO_CHAR(sb.subscribe_start_at, 'YYYY-MM-DD') AS formatted_start_date,
    TO_CHAR(sb.subscribe_end_at, 'YYYY-MM-DD') AS formatted_end_date,
    sb.is_active
FROM 
    product.store_branch sb 
LEFT JOIN 
    product.store s ON sb.store_id = s.id 
LEFT JOIN 
    subscription.subscription sc ON sb.id = sc.store_branch_id 
LEFT JOIN 
    subscription.plan p ON sc.plan_id = p.id 
WHERE 
    s.is_sandbox = false
    AND p."name" IS NOT NULL 
    AND sb."name" LIKE 'Aluna%'
    	OR sb."name" LIKE 'Air Prosses%'
        OR sb."name" LIKE 'Amna%'
        OR sb."name" LIKE 'Aneka%'
        OR sb."name" LIKE 'Ayam Gepuk Gumilang%'
        OR sb."name" LIKE 'AYMNESIA%'
        OR sb."name" LIKE 'Bakmi Ayam Abadi Sunter%'
        OR sb."name" LIKE 'Bakmi Gang Kelinci%'
        OR sb."name" LIKE 'Bakmi Gang Kelinci Bungur%'
        OR sb."name" LIKE 'Bakmi Jogja Zalfa%'
        OR sb."name" LIKE 'Balboni Pizza Alam Sutera%'
        OR sb."name" LIKE 'Bento Kopi Concat%'
        OR sb."name" LIKE 'Bento Kopi Godean%'
        OR sb."name" LIKE 'Bento Kopi Jakal%'
        OR sb."name" LIKE 'Bento Kopi JCM%'
        OR sb."name" LIKE 'Bento Kopi Klebengan%'
        OR sb."name" LIKE 'Bento Kopi Maguwoharjo%'
        OR sb."name" LIKE 'Bento Kopi Nologaten'
        OR sb."name" LIKE 'Bento Kopi Sorowajan%'
        OR sb."name" LIKE 'Bento Kopi UAD%'
        OR sb."name" LIKE 'Bento Kopi UMY%'
        OR sb."name" LIKE 'Burger Que%'
        OR sb."name" LIKE 'Byodo Coffee%'
        OR sb."name" LIKE 'Chante%'
        OR sb."name" LIKE 'Cliffton Ice%'
        OR sb."name" LIKE 'CR All the sweetness in you%'
        OR sb."name" LIKE 'Cupba%'
        OR sb."name" LIKE 'Dapur Aisyah%'
        OR sb."name" LIKE 'Dapur Ibu Fatih%'
        OR sb."name" LIKE 'Dapur Mamada%'
        OR sb."name" LIKE 'Dapur Nayara%'
        OR sb."name" LIKE 'Dapur Umay%'
        OR sb."name" LIKE 'Djowo Klaten%'
        OR sb."name" LIKE 'Dogs Ministry%'
        OR sb."name" LIKE 'Dwi Purwati Collection%'
        OR sb."name" LIKE 'Easy Breezy%'
        OR sb."name" LIKE 'Easy Breezy Malang%'
        OR sb."name" LIKE 'Eleven Ground%'
        OR sb."name" LIKE 'Es Dalgona Dewan%'
        OR sb."name" LIKE 'Ganaga ST Garage%'
        OR sb."name" LIKE 'Gurita Kurma%'
        OR sb."name" LIKE 'Hayyu Umroh%'
        OR sb."name" LIKE 'Jenggleng Cafe Bar & Resto%'
        OR sb."name" LIKE 'Kafe Rute 15%'
        OR sb."name" LIKE 'Kaktus Coffee%'
        OR sb."name" LIKE 'Kaktus Coffee Place%'
        OR sb."name" LIKE 'Kantin Nusantara Ibu Uci%'
        OR sb."name" LIKE 'Kopi Dari Hati Duren Tiga%'
        OR sb."name" LIKE 'Kopi Kren #007%'
        OR sb."name" LIKE 'Kopikuni%'
        OR sb."name" LIKE 'KOPI MACHO%'
        OR sb."name" LIKE 'Kopi Ula%'
        OR sb."name" LIKE 'Link.up cafe%'
        OR sb."name" LIKE 'Lupba Cafe%'
        OR sb."name" LIKE 'Martabak Moscow%'
        OR sb."name" LIKE 'MENTAI NI%'
        OR sb."name" LIKE 'Mie Nantang%'
        OR sb."name" LIKE 'Mimume%'
        OR sb."name" LIKE 'Miracle.Recipee%'
        OR sb."name" LIKE 'Mood River Garden%'
        OR sb."name" LIKE 'MY.Kan Cafe & Resto%'
        OR sb."name" LIKE 'Nasi Bali Nusantara Kajeto%'
        OR sb."name" LIKE 'Noma Cafe All Day Night%'
        OR sb."name" LIKE 'Odeng Coffee%'
        OR sb."name" LIKE 'Omah Bakso Jenggleng%'
        OR sb."name" LIKE 'Pawon Canarra%'
        OR sb."name" LIKE 'Pawon Mbok Laris%'
        OR sb."name" LIKE 'Pentol Oye Bandung%'
        OR sb."name" LIKE 'Prego Restaurant%'
        OR sb."name" LIKE 'Puding Kelapa Sultan%'
        OR sb."name" LIKE 'Purple House Mama Al%'
        OR sb."name" LIKE 'Raminten3 Resto%'
        OR sb."name" LIKE 'Rashya Foods By Devy$'
        OR sb."name" LIKE 'Room Service HDTI%'
        OR sb."name" LIKE 'Rumah Pepes Muslim%'
    	OR sb."name" LIKE 'Rebecca Patisserie%'
    	OR sb."name" LIKE 'Radeesya%'
    	OR sb."name" LIKE ‘Bite Nat%’
    	OR sb."name" LIKE ‘Bumbu Pecel Mbah Genah%’
    	OR sb."name" LIKE 'Corniecello Store%'
    	OR sb."name" LIKE 'Dapurpooh%'
    	OR sb."name" LIKE 'D'Syof%'
    	OR sb."name" LIKE 'Fafifa Culinary%'
    	OR sb."name" LIKE 'Ganjuran Food Court%'
    	OR sb."name" LIKE 'Kedai Lubna%'
    	OR sb."name" LIKE 'Knaffgalery%'
    	OR sb."name" LIKE 'Moms Cookies%'
    	OR sb."name" LIKE 'Nasi Ulam Istimewa%'
    	OR sb."name" LIKE 'Radeesya Sweet Corner%'
    	OR sb."name" LIKE 'RotiBhekend%'
    	OR sb."name" LIKE 'Salzi Bakery & Catering%'
    	OR sb."name" LIKE 'Ummi Kitchen%'
        OR sb."name" LIKE 'Shava Coffee%'
        OR sb."name" LIKE 'Sobat Mentai%'
        OR sb."name" LIKE 'Spesial Nasi Campur Bali%'
        OR sb."name" LIKE 'Station Kupi%'
        OR sb."name" LIKE 'Steki%'
        OR sb."name" LIKE 'Teleskopikafe%'
        OR sb."name" LIKE 'Warung Rafa%'
        OR sb."name" LIKE 'Warunk Genji%'
        OR sb."name" LIKE 'Winata Jaya Cafe%'
        OR sb."name" LIKE 'Winata Jaya Printing%'
        OR sb."name" LIKE 'Yolk Kitchen%'
        OR sb."name" LIKE 'Zizi Pizzeria & Coffee%';
# NO MERCHANT FILTER

SELECT q1.name,
       q1.total_order_fee_amount,
       q2.total_subscription_amount,
       q1.total_success_order,
       q2.total_repitition_subscribing
FROM (
    SELECT sb.name,
           sb.id,
           SUM(os.order_fee) AS total_order_fee_amount,
           COUNT(*) AS total_success_order
    FROM sales.summary_transaction os
    LEFT JOIN product.store_branch sb ON sb.id = os.store_branch_id
    LEFT JOIN product.store s ON s.id = sb.store_id
    WHERE s.is_sandbox = FALSE
      AND os.order_session_status_name IN ('Delivered', 'Paid off')
    GROUP BY sb.name, sb.id
) q1
LEFT JOIN (
    SELECT sb.name,
           sb.id,
           SUM(pp.normal_price) AS total_subscription_amount,
           COUNT(*) AS total_repitition_subscribing
    FROM subscription.subscription s
    LEFT JOIN product.store_branch sb ON sb.id = s.store_branch_id
    LEFT JOIN product.store st ON st.id = sb.store_id
    LEFT JOIN subscription.plan_price pp ON pp.id = s.plan_price_id
    GROUP BY sb.name, sb.id
) q2 ON q2.id = q1.id
